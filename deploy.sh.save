#!/usr/bin/env bash

if [ -z "${BASH_VERSION:-}" ]; then
  printf '\033[31mERROR:\033[0m This script must be run with bash\n' >&2
  printf 'Run it as: bash %s\n' "$0" >&2
  exit 1
fi

# --- Cleanup Function (Triggered by Ctrl+C) ---
cleanup() {
    echo ""
    printf '\033[33mCtrl + C Detected Cleaning Enviroment user\033[0m\n'


    echo "Cleanup complete. Exiting."
    exit 0
}
trap cleanup SIGINT


BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"


if [ -f "${BASE_DIR}/requirements.sh" ]; then
    printf '\033[33m[TRYING]\033[0m Installing dependencies\n'
    bash ${BASE_DIR}/requirements.sh "${@}"
    if $! error then print "[error in red] error in dependencies install, aborting processes"
        else print[SUCCESS in green] Dependencies install
    printf '\033[33m []\033[0m\n'
fi

if [ ! -d "venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv venv
fi

echo "Launching cron jobs"
bash ${BASE_DIR}/scripts/launch_cron.sh

echo "--- Launching Application ---"

echo "Trying to kill old gunicorn processes"
pkill -f "gunicorn" || true

echo "Gunicorn PID in ${BASE_DIR}/logs/gunicorn.pid"
echo "Gunicorn LOGS in ${BASE_DIR}/logs/gunicorn.log"

nohup gunicorn wsgi:app \
  --bind 127.0.0.1:8443 \
  --workers 4 --threads 2 --timeout 60 \
  --pid ${BASE_DIR}/logs/gunicorn.pid \
  > ${BASE_DIR}/logs/gunicorn.log 2>&1 &

